{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-9">
        <div class="card shadow border-left-success">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="m-0 fw-bold"><i class="fas fa-quran me-2"></i>Catat Setoran Hafalan</h5>
                <span class="badge bg-white text-success">Mode Cerdas</span>
            </div>
            <div class="card-body">
                <form method="POST">

                    <div class="mb-4">
                        <label class="form-label fw-bold">Pilih Santri</label>
                        <select name="student_id" class="form-select select2" required>
                            <option value="">-- Cari Nama Santri --</option>
                            {% for s in students %}
                                <option value="{{ s.id }}">{{ s.full_name }} ({{ s.nis }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Jenis Setoran</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="type" id="type1" value="ZIYADAH" checked>
                            <label class="btn btn-outline-success" for="type1">ZIYADAH (Hafalan Baru)</label>

                            <input type="radio" class="btn-check" name="type" id="type2" value="MURAJAAH">
                            <label class="btn btn-outline-primary" for="type2">MURAJAAH (Mengulang)</label>
                        </div>
                    </div>

                    <hr>

                    <div class="row g-3 align-items-center mb-2">
                        <div class="col-md-12"><h6 class="fw-bold text-muted">Titik Mulai (Dari)</h6></div>

                        <div class="col-md-5">
                            <label class="small text-muted">Surat</label>
                            <select id="startSurah" name="start_surah" class="form-select select2-surah" required onchange="syncEndSurah(); detectJuz()">
                                </select>
                        </div>

                        <div class="col-md-3">
                            <label class="small text-muted">Ayat</label>
                            <input type="number" id="startAyat" name="ayat_start" class="form-control" placeholder="1" required oninput="detectJuz()">
                        </div>

                        <div class="col-md-4">
                            <label class="small text-muted">Posisi Juz (Otomatis)</label>
                            <input type="text" id="juzDisplay" class="form-control bg-light fw-bold text-success" readonly placeholder="...">
                            <input type="hidden" name="juz_start" id="juzValue">
                        </div>
                    </div>

                    <div class="row g-3 align-items-center mb-4">
                        <div class="col-md-12"><h6 class="fw-bold text-muted mt-2">Titik Akhir (Sampai)</h6></div>

                        <div class="col-md-5">
                            <label class="small text-muted">Surat</label>
                            <select id="endSurah" name="end_surah" class="form-select select2-surah" required onchange="detectJuz()">
                                </select>
                        </div>

                        <div class="col-md-3">
                            <label class="small text-muted">Ayat</label>
                            <input type="number" id="endAyat" name="ayat_end" class="form-control" placeholder="Akhir" required oninput="detectJuz()">
                        </div>

                         <div class="col-md-4 d-flex align-items-end">
                            <small id="rangeInfo" class="text-primary fst-italic"></small>
                        </div>
                    </div>

                    <hr>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Kualitas & Catatan</label>
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <select name="quality" class="form-select">
                                    <option value="Mumtaz">Mumtaz (Sempurna)</option>
                                    <option value="Jayyid Jiddan">Jayyid Jiddan</option>
                                    <option value="Jayyid">Jayyid (Baik)</option>
                                    <option value="Maqbul">Maqbul (Cukup)</option>
                                    <option value="Naqis">Naqis (Kurang)</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <input type="text" name="notes" class="form-control" placeholder="Catatan untuk santri/wali...">
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-success btn-lg fw-bold shadow-sm">
                            <i class="fas fa-save me-2"></i>Simpan Hafalan
                        </button>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. DATA REFERENSI LENGKAP (Mapping Surat & Jumlah Ayat)
    const surahData = [
        {id:1,n:"Al-Fatihah",c:7},{id:2,n:"Al-Baqarah",c:286},{id:3,n:"Ali 'Imran",c:200},{id:4,n:"An-Nisa'",c:176},{id:5,n:"Al-Ma'idah",c:120},
        {id:6,n:"Al-An'am",c:165},{id:7,n:"Al-A'raf",c:206},{id:8,n:"Al-Anfal",c:75},{id:9,n:"At-Taubah",c:129},{id:10,n:"Yunus",c:109},
        {id:11,n:"Hud",c:123},{id:12,n:"Yusuf",c:111},{id:13,n:"Ar-Ra'd",c:43},{id:14,n:"Ibrahim",c:52},{id:15,n:"Al-Hijr",c:99},
        {id:16,n:"An-Nahl",c:128},{id:17,n:"Al-Isra'",c:111},{id:18,n:"Al-Kahf",c:110},{id:19,n:"Maryam",c:98},{id:20,n:"Ta-Ha",c:135},
        {id:21,n:"Al-Anbiya'",c:112},{id:22,n:"Al-Hajj",c:78},{id:23,n:"Al-Mu'minun",c:118},{id:24,n:"An-Nur",c:64},{id:25,n:"Al-Furqan",c:77},
        {id:26,n:"Asy-Syu'ara'",c:227},{id:27,n:"An-Naml",c:93},{id:28,n:"Al-Qasas",c:88},{id:29,n:"Al-'Ankabut",c:69},{id:30,n:"Ar-Rum",c:60},
        {id:31,n:"Luqman",c:34},{id:32,n:"As-Sajdah",c:30},{id:33,n:"Al-Ahzab",c:73},{id:34,n:"Saba'",c:54},{id:35,n:"Fatir",c:45},
        {id:36,n:"Ya-Sin",c:83},{id:37,n:"As-Saffat",c:182},{id:38,n:"Sad",c:88},{id:39,n:"Az-Zumar",c:75},{id:40,n:"Ghafir",c:85},
        {id:41,n:"Fussilat",c:54},{id:42,n:"Asy-Syura",c:53},{id:43,n:"Az-Zukhruf",c:89},{id:44,n:"Ad-Dukhan",c:59},{id:45,n:"Al-Jasiyah",c:37},
        {id:46,n:"Al-Ahqaf",c:35},{id:47,n:"Muhammad",c:38},{id:48,n:"Al-Fath",c:29},{id:49,n:"Al-Hujurat",c:18},{id:50,n:"Qaf",c:45},
        {id:51,n:"Az-Zariyat",c:60},{id:52,n:"At-Tur",c:49},{id:53,n:"An-Najm",c:62},{id:54,n:"Al-Qamar",c:55},{id:55,n:"Ar-Rahman",c:78},
        {id:56,n:"Al-Waqi'ah",c:96},{id:57,n:"Al-Hadid",c:29},{id:58,n:"Al-Mujadilah",c:22},{id:59,n:"Al-Hasyr",c:24},{id:60,n:"Al-Mumtahanah",c:13},
        {id:61,n:"As-Saff",c:14},{id:62,n:"Al-Jumu'ah",c:11},{id:63,n:"Al-Munafiqun",c:11},{id:64,n:"At-Taghabun",c:18},{id:65,n:"At-Talaq",c:12},
        {id:66,n:"At-Tahrim",c:12},{id:67,n:"Al-Mulk",c:30},{id:68,n:"Al-Qalam",c:52},{id:69,n:"Al-Haqqah",c:52},{id:70,n:"Al-Ma'arij",c:44},
        {id:71,n:"Nuh",c:28},{id:72,n:"Al-Jinn",c:28},{id:73,n:"Al-Muzzammil",c:20},{id:74,n:"Al-Muddassir",c:56},{id:75,n:"Al-Qiyamah",c:40},
        {id:76,n:"Al-Insan",c:31},{id:77,n:"Al-Mursalat",c:50},{id:78,n:"An-Naba'",c:40},{id:79,n:"An-Nazi'at",c:46},{id:80,n:"'Abasa",c:42},
        {id:81,n:"At-Takwir",c:29},{id:82,n:"Al-Infitar",c:19},{id:83,n:"Al-Mutaffifin",c:36},{id:84,n:"Al-Insyiqaq",c:25},{id:85,n:"Al-Buruj",c:22},
        {id:86,n:"At-Tariq",c:17},{id:87,n:"Al-A'la",c:19},{id:88,n:"Al-Ghasyiyah",c:26},{id:89,n:"Al-Fajr",c:30},{id:90,n:"Al-Balad",c:20},
        {id:91,n:"Asy-Syams",c:15},{id:92,n:"Al-Lail",c:21},{id:93,n:"Ad-Duha",c:11},{id:94,n:"Al-Insyirah",c:8},{id:95,n:"At-Tin",c:8},
        {id:96,n:"Al-'Alaq",c:19},{id:97,n:"Al-Qadr",c:5},{id:98,n:"Al-Bayyinah",c:8},{id:99,n:"Az-Zalzalah",c:8},{id:100,n:"Al-'Adiyat",c:11},
        {id:101,n:"Al-Qari'ah",c:11},{id:102,n:"At-Takasur",c:8},{id:103,n:"Al-'Asr",c:3},{id:104,n:"Al-Humazah",c:9},{id:105,n:"Al-Fil",c:5},
        {id:106,n:"Quraisy",c:4},{id:107,n:"Al-Ma'un",c:7},{id:108,n:"Al-Kausar",c:3},{id:109,n:"Al-Kafirun",c:6},{id:110,n:"An-Nasr",c:3},
        {id:111,n:"Al-Lahab",c:5},{id:112,n:"Al-Ikhlas",c:4},{id:113,n:"Al-Falaq",c:5},{id:114,n:"An-Nas",c:6}
    ];

    // 2. DATA START JUZ (Format: [No Juz, ID Surat, No Ayat])
    // Contoh: Juz 2 mulai di Surat 2 (Al-Baqarah) Ayat 142
    const juzStartMap = [
        [1,1,1], [2,2,142], [3,2,253], [4,3,93], [5,4,24], [6,4,148],
        [7,5,82], [8,6,111], [9,7,88], [10,8,41], [11,9,93], [12,11,6],
        [13,12,53], [14,15,1], [15,17,1], [16,18,75], [17,21,1], [18,23,1],
        [19,25,21], [20,27,56], [21,29,46], [22,33,31], [23,36,28], [24,39,32],
        [25,41,47], [26,46,1], [27,51,31], [28,58,1], [29,67,1], [30,78,1]
    ];

    document.addEventListener("DOMContentLoaded", function() {
        populateSurah('startSurah');
        populateSurah('endSurah');

        // Inisialisasi Select2
        if (typeof jQuery !== 'undefined' && jQuery.fn.select2) {
            $('.select2').select2({theme: 'bootstrap-5'});
            $('.select2-surah').select2({theme: 'bootstrap-5'});
        }
    });

    function populateSurah(elementId) {
        const select = document.getElementById(elementId);
        surahData.forEach(s => {
            let option = document.createElement("option");
            option.value = s.n;
            option.text = `${s.id}. ${s.n} (${s.c} ayat)`;
            option.setAttribute('data-id', s.id);
            option.setAttribute('data-count', s.c);
            select.appendChild(option);
        });
    }

    // Fungsi: Jika User ubah surat awal, surat akhir otomatis sama (biar cepat)
    function syncEndSurah() {
        const start = document.getElementById('startSurah').value;
        const endSelect = document.getElementById('endSurah');
        // Hanya sync jika surat akhir masih kosong atau belum disentuh
        if (endSelect.value === "") {
            endSelect.value = start;
            // Trigger perubahan untuk select2 jika dipakai
            if (typeof jQuery !== 'undefined') $(endSelect).trigger('change');
        }
    }

    // 3. LOGIKA DETEKSI JUZ & VALIDASI
    function detectJuz() {
        // Ambil data dari form
        const startSurahName = document.getElementById('startSurah').value;
        const startAyat = parseInt(document.getElementById('startAyat').value) || 0;

        // Cari Object Surat berdasarkan nama
        const sObj = surahData.find(s => s.n === startSurahName);

        if (!sObj) return;

        // Validasi Maksimal Ayat
        if (startAyat > sObj.c) {
            document.getElementById('startAyat').value = sObj.c; // Auto correct
        }

        // --- ALGORITMA CARI JUZ ---
        // Kita loop array juzStartMap dari belakang (Juz 30 ke 1)
        // Jika posisi kita >= posisi start juz tersebut, maka itulah juz-nya.

        let detectedJuz = 1; // Default

        // Logic: Juz X dimulai di Surat A Ayat B
        // Kita cek: Apakah Surat Pilihan > Surat A? ATAU (Surat Pilihan == Surat A DAN Ayat Pilihan >= Ayat B)?

        for (let i = juzStartMap.length - 1; i >= 0; i--) {
            const [juzNo, suratId, ayatNo] = juzStartMap[i];

            if (sObj.id > suratId) {
                detectedJuz = juzNo;
                break;
            } else if (sObj.id === suratId && startAyat >= ayatNo) {
                detectedJuz = juzNo;
                break;
            }
        }

        // Tampilkan Hasil
        document.getElementById('juzDisplay').value = "Juz " + detectedJuz;
        document.getElementById('juzValue').value = detectedJuz;

        // Info Tambahan (Range)
        const endSurahName = document.getElementById('endSurah').value;
        const endAyat = document.getElementById('endAyat').value;
        const info = document.getElementById('rangeInfo');

        if (startSurahName !== endSurahName && endSurahName) {
            info.innerHTML = `<i class="fas fa-info-circle"></i> Setoran lintas surat: <b>${startSurahName}</b> ke <b>${endSurahName}</b>`;
        } else {
            info.innerHTML = "";
        }
    }
</script>
{% endblock %}