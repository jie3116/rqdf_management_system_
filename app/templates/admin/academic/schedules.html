{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">Manajemen Jadwal Pelajaran</h1>

    <div class="card shadow mb-4">
        <div class="card-body">
            <form method="GET" action="{{ url_for('admin.manage_schedules') }}" class="row align-items-end">
                <div class="col-md-8">
                    <label class="fw-bold">Pilih Kelas:</label>
                    <select name="class_id" id="select-class" class="form-select" onchange="this.form.submit()">
                        <option value="">-- Pilih Kelas --</option>
                        {% for c in classes %}
                            <option value="{{ c.id }}" {% if selected_class and selected_class.id == c.id %}selected{% endif %}>
                                {{ c.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>
    </div>

    {% if selected_class %}
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">Jadwal: {{ selected_class.name }}</h6>
            <button class="btn btn-primary btn-sm" onclick="openAddModal()">
                <i class="fas fa-plus fa-sm text-white-50"></i> Tambah Mapel
            </button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-striped" width="100%" cellspacing="0">
                    <thead class="table-dark">
                        <tr>
                            <th>Hari</th>
                            <th>Jam</th>
                            <th>Mata Pelajaran</th>
                            <th>Guru</th>
                            <th width="15%">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if schedules %}
                            {% for sch in schedules %}
                            <tr>
                                <td class="fw-bold"><span class="badge bg-info">{{ sch.day }}</span></td>
                                <td>{{ sch.start_time.strftime('%H:%M') }} - {{ sch.end_time.strftime('%H:%M') }}</td>
                                <td>{{ sch.subject.name }}</td>
                                <td>{{ sch.teacher.full_name }}</td>
                                <td class="text-center">
                                    <button class="btn btn-warning btn-sm btn-edit"
                                            data-id="{{ sch.id }}"
                                            data-day="{{ sch.day }}"
                                            data-start="{{ sch.start_time.strftime('%H:%M') }}"
                                            data-end="{{ sch.end_time.strftime('%H:%M') }}"
                                            data-subject="{{ sch.subject_id }}"
                                            data-teacher="{{ sch.teacher_id }}"
                                            onclick="openEditModal(this)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <form action="{{ url_for('admin.delete_schedule', id=sch.id) }}" method="POST" style="display:inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Yakin ingin menghapus jadwal ini?')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="5" class="text-center py-4 text-muted">Belum ada jadwal.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

</div>

<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitle">Tambah Jadwal</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <form method="POST" id="scheduleForm" action="{{ url_for('admin.manage_schedules') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-body">
                    <input type="hidden" name="class_id" value="{{ selected_class.id if selected_class else '' }}">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Hari</label>
                        <select name="day" id="inputDay" class="form-select" required>
                            <option value="Senin">Senin</option>
                            <option value="Selasa">Selasa</option>
                            <option value="Rabu">Rabu</option>
                            <option value="Kamis">Kamis</option>
                            <option value="Jumat">Jumat</option>
                            <option value="Sabtu">Sabtu</option>
                            <option value="Minggu">Minggu</option>
                        </select>
                    </div>

                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label fw-bold">Jam Mulai</label>
                            <input type="time" name="start_time" id="inputStart" class="form-control" required>
                        </div>
                        <div class="col">
                            <label class="form-label fw-bold">Jam Selesai</label>
                            <input type="time" name="end_time" id="inputEnd" class="form-control" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Mata Pelajaran</label>
                        <select name="subject_id" id="inputSubject" class="form-select select2-modal" required style="width: 100%">
                            <option value="">-- Pilih Mapel --</option>
                            {% for sub in subjects %}
                                <option value="{{ sub.id }}">{{ sub.name }} ({{ sub.code }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Guru Pengampu</label>
                        <select name="teacher_id" id="inputTeacher" class="form-select select2-modal" required style="width: 100%">
                            <option value="">-- Pilih Guru --</option>
                            {% for t in teachers %}
                                <option value="{{ t.id }}">{{ t.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // URL Default untuk Create (diambil dari Flask)
    const CREATE_URL = "{{ url_for('admin.manage_schedules') }}";
    // Base URL untuk Edit (nanti ditambah ID via JS)
    const EDIT_URL_BASE = "{{ url_for('admin.edit_schedule', id=0) }}".slice(0, -1);

    // 1. Fungsi Buka Modal TAMBAH
    function openAddModal() {
        document.getElementById('modalTitle').innerText = "Tambah Jadwal";
        document.getElementById('scheduleForm').action = CREATE_URL;

        // Reset Form
        document.getElementById('inputDay').value = "Senin";
        document.getElementById('inputStart').value = "";
        document.getElementById('inputEnd').value = "";

        // Reset Select2
        $('#inputSubject').val(null).trigger('change');
        $('#inputTeacher').val(null).trigger('change');

        // Tampilkan Modal
        var myModal = new bootstrap.Modal(document.getElementById('scheduleModal'));
        myModal.show();
    }

    // 2. Fungsi Buka Modal EDIT
    function openEditModal(button) {
        document.getElementById('modalTitle').innerText = "Edit Jadwal";

        // Ambil data dari atribut tombol
        let id = button.getAttribute('data-id');
        let day = button.getAttribute('data-day');
        let start = button.getAttribute('data-start');
        let end = button.getAttribute('data-end');
        let sub = button.getAttribute('data-subject');
        let teach = button.getAttribute('data-teacher');

        // Set Action Form ke URL Edit
        document.getElementById('scheduleForm').action = EDIT_URL_BASE + id;

        // Isi Inputan
        document.getElementById('inputDay').value = day;
        document.getElementById('inputStart').value = start;
        document.getElementById('inputEnd').value = end;

        // Isi Select2 (perlu trigger change agar UI update)
        $('#inputSubject').val(sub).trigger('change');
        $('#inputTeacher').val(teach).trigger('change');

        // Tampilkan Modal
        var myModal = new bootstrap.Modal(document.getElementById('scheduleModal'));
        myModal.show();
    }

    // 3. Inisialisasi Select2
    document.addEventListener("DOMContentLoaded", function() {
        if (typeof jQuery !== 'undefined' && jQuery.fn.select2) {
            $('#select-class').select2({ placeholder: "-- Pilih Kelas --", width: '100%' });
            $('.select2-modal').select2({
                dropdownParent: $('#scheduleModal'),
                width: '100%',
                placeholder: "-- Pilih --"
            });
        }
    });
</script>
{% endblock %}