{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">Jadwal Kegiatan Boarding</h1>
</div>

<div class="card shadow mb-4">
    <div class="card-header bg-primary text-white"><strong>Tambah Template Jadwal Kegiatan</strong></div>
    <div class="card-body">
        <form method="POST" class="row g-3">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="action" value="add_schedule">

            <div class="col-md-3">
                <label class="form-label">Nama Kegiatan</label>
                <input type="text" name="activity_name" class="form-control" placeholder="Contoh: Shalat Subuh" required>
            </div>
            <div class="col-md-2">
                <label class="form-label">Jam Mulai</label>
                <input type="time" name="start_time" class="form-control" required>
            </div>
            <div class="col-md-2">
                <label class="form-label">Jam Selesai</label>
                <input type="time" name="end_time" class="form-control" required>
            </div>
            <div class="col-md-5">
                <label class="form-label d-block">Cakupan Asrama</label>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="allDorms" name="applies_all_dormitories" checked>
                    <label class="form-check-label" for="allDorms">Berlaku untuk semua asrama (default)</label>
                </div>
                <select class="form-select" name="selected_dormitories" id="selectedDorms" multiple disabled>
                    {% for dorm in dormitories %}
                    <option value="{{ dorm.id }}">{{ dorm.name }}</option>
                    {% endfor %}
                </select>
                <small class="text-muted">Jika tidak semua, pilih satu/lebih asrama.</small>
            </div>

            <div class="col-md-7">
                <label class="form-label d-block">Cakupan Hari</label>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="allDays" name="applies_all_days" checked>
                    <label class="form-check-label" for="allDays">Berlaku untuk semua hari (default)</label>
                </div>
                <div id="selectedDaysWrap" class="d-flex flex-wrap gap-2">
                    {% for day in DAYS %}
                    <div class="form-check form-check-inline">
                        <input class="form-check-input day-box" type="checkbox" name="selected_days" value="{{ day }}" id="day_{{ loop.index }}" disabled>
                        <label class="form-check-label" for="day_{{ loop.index }}">{{ day }}</label>
                    </div>
                    {% endfor %}
                </div>
                <small class="text-muted">Biasanya semua hari, kecuali hari tertentu seperti Jumat/Sabtu/Minggu.</small>
            </div>

            <div class="col-md-5">
                <label class="form-label d-block">Hari Libur</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="exclude_national_holidays" id="excludeHoliday" checked>
                    <label class="form-check-label" for="excludeHoliday">Tidak berlaku saat hari libur nasional/khusus</label>
                </div>
            </div>

            <div class="col-12 text-end">
                <button class="btn btn-primary" type="submit">Simpan Template Jadwal</button>
            </div>
        </form>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <strong>Daftar Template Jadwal</strong>
        <form method="GET" class="d-flex gap-2 align-items-center">
            <label class="small text-muted mb-0">Filter Asrama:</label>
            <select name="dormitory_id" class="form-select form-select-sm" onchange="this.form.submit()">
                <option value="">Semua Asrama</option>
                {% for dorm in dormitories %}
                <option value="{{ dorm.id }}" {% if selected_dormitory and selected_dormitory.id == dorm.id %}selected{% endif %}>{{ dorm.name }}</option>
                {% endfor %}
            </select>
        </form>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Kegiatan</th>
                        <th>Jam</th>
                        <th>Cakupan Asrama</th>
                        <th>Cakupan Hari</th>
                        <th>Libur Nasional</th>
                        <th>Status</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for schedule in schedules %}
                    {% set schedule_days = selected_days(schedule) %}
                    <tr>
                        <td>{{ schedule.activity_name }}</td>
                        <td>{{ schedule.start_time.strftime('%H:%M') }} - {{ schedule.end_time.strftime('%H:%M') }}</td>
                        <td>
                            {% if schedule.applies_all_dormitories %}
                            <span class="badge bg-success">Semua Asrama</span>
                            {% else %}
                                {% for dorm in schedule.selected_dormitories %}
                                <span class="badge bg-info text-dark">{{ dorm.name }}</span>
                                {% else %}
                                <span class="text-muted">(Legacy) Asrama ID: {{ schedule.dormitory_id }}</span>
                                {% endfor %}
                            {% endif %}
                        </td>
                        <td>
                            {% if schedule.applies_all_days %}
                            <span class="badge bg-primary">Semua Hari</span>
                            {% else %}
                                {% for day in schedule_days %}
                                <span class="badge bg-secondary">{{ day }}</span>
                                {% endfor %}
                            {% endif %}
                        </td>
                        <td>
                            {% if schedule.exclude_national_holidays %}
                            <span class="badge bg-warning text-dark">Tidak Berlaku saat Libur</span>
                            {% else %}
                            <span class="badge bg-light text-dark border">Tetap Berlaku</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if schedule.is_active %}
                            <span class="badge bg-success">Aktif</span>
                            {% else %}
                            <span class="badge bg-secondary">Nonaktif</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="d-flex gap-1">
                                <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#editSchedule{{ schedule.id }}">
                                    Edit
                                </button>
                                <form method="POST" onsubmit="return confirm('Ubah status template ini?')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="hidden" name="action" value="toggle_schedule">
                                    <input type="hidden" name="schedule_id" value="{{ schedule.id }}">
                                    {% if selected_dormitory %}
                                    <input type="hidden" name="dormitory_id" value="{{ selected_dormitory.id }}">
                                    {% endif %}
                                    <button class="btn btn-sm {% if schedule.is_active %}btn-outline-warning{% else %}btn-outline-success{% endif %}" type="submit">
                                        {% if schedule.is_active %}Nonaktifkan{% else %}Aktifkan{% endif %}
                                    </button>
                                </form>
                                <form method="POST" onsubmit="return confirm('Hapus template jadwal ini?')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="hidden" name="action" value="delete_schedule">
                                    <input type="hidden" name="schedule_id" value="{{ schedule.id }}">
                                    {% if selected_dormitory %}
                                    <input type="hidden" name="dormitory_id" value="{{ selected_dormitory.id }}">
                                    {% endif %}
                                    <button class="btn btn-sm btn-outline-danger" type="submit">Hapus</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    <tr class="collapse" id="editSchedule{{ schedule.id }}">
                        <td colspan="7" class="bg-light">
                            <form method="POST" class="row g-2">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="action" value="update_schedule">
                                <input type="hidden" name="schedule_id" value="{{ schedule.id }}">
                                {% if selected_dormitory %}
                                <input type="hidden" name="dormitory_id" value="{{ selected_dormitory.id }}">
                                {% endif %}

                                <div class="col-md-3">
                                    <label class="form-label small">Nama Kegiatan</label>
                                    <input type="text" class="form-control form-control-sm" name="activity_name" value="{{ schedule.activity_name }}" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Jam Mulai</label>
                                    <input type="time" class="form-control form-control-sm" name="start_time" value="{{ schedule.start_time.strftime('%H:%M') }}" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Jam Selesai</label>
                                    <input type="time" class="form-control form-control-sm" name="end_time" value="{{ schedule.end_time.strftime('%H:%M') }}" required>
                                </div>
                                <div class="col-md-5">
                                    <label class="form-label small d-block">Cakupan Asrama</label>
                                    <div class="form-check mb-1">
                                        <input class="form-check-input edit-all-dorms" type="checkbox" id="editAllDorms{{ schedule.id }}" name="applies_all_dormitories" {% if schedule.applies_all_dormitories %}checked{% endif %}>
                                        <label class="form-check-label small" for="editAllDorms{{ schedule.id }}">Semua asrama</label>
                                    </div>
                                    <select class="form-select form-select-sm edit-selected-dorms" name="selected_dormitories" id="editSelectedDorms{{ schedule.id }}" multiple {% if schedule.applies_all_dormitories %}disabled{% endif %}>
                                        {% set selected_dorm_ids = schedule.selected_dormitories | map(attribute='id') | list %}
                                        {% for dorm in dormitories %}
                                        <option value="{{ dorm.id }}" {% if dorm.id in selected_dorm_ids %}selected{% endif %}>{{ dorm.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label small d-block">Cakupan Hari</label>
                                    <div class="form-check mb-1">
                                        <input class="form-check-input edit-all-days" type="checkbox" id="editAllDays{{ schedule.id }}" name="applies_all_days" {% if schedule.applies_all_days %}checked{% endif %}>
                                        <label class="form-check-label small" for="editAllDays{{ schedule.id }}">Semua hari</label>
                                    </div>
                                    <div class="d-flex flex-wrap gap-2">
                                        {% for day in DAYS %}
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input edit-day-box-{{ schedule.id }}" type="checkbox" name="selected_days" value="{{ day }}" id="editDay{{ schedule.id }}_{{ loop.index }}" {% if day in schedule_days %}checked{% endif %} {% if schedule.applies_all_days %}disabled{% endif %}>
                                            <label class="form-check-label small" for="editDay{{ schedule.id }}_{{ loop.index }}">{{ day }}</label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small d-block">Libur</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="exclude_national_holidays" id="editHoliday{{ schedule.id }}" {% if schedule.exclude_national_holidays %}checked{% endif %}>
                                        <label class="form-check-label small" for="editHoliday{{ schedule.id }}">Skip saat hari libur</label>
                                    </div>
                                </div>
                                <div class="col-12 text-end">
                                    <button class="btn btn-sm btn-primary" type="submit">Simpan Perubahan</button>
                                </div>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="7" class="text-center text-muted">Belum ada template jadwal.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="card shadow">
    <div class="card-header bg-success text-white"><strong>Hari Libur Boarding</strong></div>
    <div class="card-body">
        <form method="POST" class="row g-3 mb-3">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="action" value="add_holiday">
            <div class="col-md-3">
                <label class="form-label">Tanggal Libur</label>
                <input type="date" name="holiday_date" class="form-control" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">Nama Libur</label>
                <input type="text" name="holiday_name" class="form-control" placeholder="Contoh: Hari Raya Idul Fitri" required>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" name="is_national" id="isNational" checked>
                    <label class="form-check-label" for="isNational">Libur Nasional</label>
                </div>
            </div>
            <div class="col-12 text-end">
                <button class="btn btn-success" type="submit">Simpan Hari Libur</button>
            </div>
        </form>

        <div class="table-responsive">
            <table class="table table-bordered table-hover">
                <thead class="table-light"><tr><th>Tanggal</th><th>Nama</th><th>Tipe</th></tr></thead>
                <tbody>
                    {% for item in holidays %}
                    <tr>
                        <td>{{ item.date.strftime('%d-%m-%Y') }}</td>
                        <td>{{ item.name }}</td>
                        <td>{% if item.is_national %}Nasional{% else %}Khusus{% endif %}</td>
                    </tr>
                    {% else %}
                    <tr><td colspan="3" class="text-center text-muted">Belum ada hari libur.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
(function () {
    const allDorms = document.getElementById('allDorms');
    const selectedDorms = document.getElementById('selectedDorms');
    const allDays = document.getElementById('allDays');
    const dayBoxes = document.querySelectorAll('.day-box');

    function syncDorms() {
        if (!selectedDorms) return;
        selectedDorms.disabled = allDorms.checked;
    }

    function syncDays() {
        dayBoxes.forEach((el) => {
            el.disabled = allDays.checked;
            if (allDays.checked) {
                el.checked = false;
            }
        });
    }

    if (allDorms) {
        allDorms.addEventListener('change', syncDorms);
        syncDorms();
    }
    if (allDays) {
        allDays.addEventListener('change', syncDays);
        syncDays();
    }

    const editAllDorms = document.querySelectorAll('.edit-all-dorms');
    editAllDorms.forEach((checkbox) => {
        checkbox.addEventListener('change', function () {
            const scheduleId = this.id.replace('editAllDorms', '');
            const target = document.getElementById('editSelectedDorms' + scheduleId);
            if (target) {
                target.disabled = this.checked;
            }
        });
    });

    const editAllDays = document.querySelectorAll('.edit-all-days');
    editAllDays.forEach((checkbox) => {
        checkbox.addEventListener('change', function () {
            const scheduleId = this.id.replace('editAllDays', '');
            const boxes = document.querySelectorAll('.edit-day-box-' + scheduleId);
            boxes.forEach((box) => {
                box.disabled = this.checked;
                if (this.checked) {
                    box.checked = false;
                }
            });
        });
    });
})();
</script>
{% endblock %}
