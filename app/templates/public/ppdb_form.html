{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow border-0 border-top border-5 border-primary mb-4">
            <div class="card-body p-5">
                <div class="text-center mb-4">
                    <h1 class="fw-bold text-primary">Pendaftaran Santri Baru</h1>
                    <p class="text-muted lead">Tahun Ajaran 2026/2027</p>
                </div>
                <hr>
                <div class="alert alert-info border-0 shadow-sm">
                    <i class="fas fa-info-circle me-2"></i>
                    Silakan isi data di bawah ini dengan benar sesuai Ijazah/KK.
                </div>
            </div>
        </div>

        <form method="POST">
            {{ form.hidden_tag() }}

            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="m-0 fw-bold text-primary"><i class="fas fa-list-alt me-2"></i>1. Pilihan Program</h5>
                </div>
                <div class="card-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Program yang dituju <span class="text-danger">*</span></label>
                        {{ form.program_type(class="form-select form-select-lg bg-light border-primary", id="programSelector") }}
                        <small class="text-muted">Pilih "RQDF Reguler" untuk Tahfidz Sore, atau "Sekolah Bina Qur'an" untuk Sekolah Formal.</small>
                    </div>

                    <div id="group_sekolah_formal">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Jenjang Pendidikan</label>
                                {{ form.education_level(class="form-select") }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Jalur Pendaftaran</label>
                                {{ form.scholarship_category(class="form-select", id="scholarshipSelector") }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="m-0 fw-bold text-primary"><i class="fas fa-user me-2"></i>2. Data Calon Santri</h5>
                </div>
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nama Lengkap <span class="text-danger">*</span></label>
                            {{ form.full_name(class="form-control", placeholder="Sesuai Ijazah") }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nama Panggilan</label>
                            {{ form.nickname(class="form-control") }}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">NIK (16 Digit)</label>
                            {{ form.nik(class="form-control", placeholder="Cth: 3201xxxxxxxxxxxx", maxlength="16") }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">No. Kartu Keluarga</label>
                            {{ form.kk_number(class="form-control", maxlength="16") }}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label d-block">Jenis Kelamin <span class="text-danger">*</span></label>
                        {% for subfield in form.gender %}
                            <div class="form-check form-check-inline">
                                {{ subfield(class="form-check-input") }}
                                {{ subfield.label(class="form-check-label") }}
                            </div>
                        {% endfor %}
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tempat Lahir</label>
                            {{ form.place_of_birth(class="form-control") }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tanggal Lahir</label>
                            {{ form.date_of_birth(class="form-control", type="date") }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Usia</label>
                            {{ form.age(class="form-control") }}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Alamat Lengkap (Domisili)</label>
                        {{ form.address(class="form-control", rows="2") }}
                    </div>

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Sekolah Asal</label>
                            {{ form.previous_school(class="form-control") }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Kelas Terakhir</label>
                            {{ form.previous_school_class(class="form-control") }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="m-0 fw-bold text-primary"><i class="fas fa-users me-2"></i>3. Data Orang Tua</h5>
                </div>
                <div class="card-body p-4">
                    <div class="row border-bottom pb-3 mb-3">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Nama Ayah</label>
                            {{ form.father_name(class="form-control") }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Pekerjaan</label>
                            {{ form.father_job(class="form-control") }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Penghasilan Ayah</label>
                            {{ form.father_income_range(class="form-select") }}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Nama Ibu</label>
                            {{ form.mother_name(class="form-control") }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Pekerjaan</label>
                            {{ form.mother_job(class="form-control") }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Penghasilan Ibu</label>
                            {{ form.mother_income_range(class="form-select") }}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">No. WhatsApp Orang Tua (Aktif) <span class="text-danger">*</span></label>
                        {{ form.parent_phone(class="form-control bg-light", placeholder="08xxxxxxxxxx") }}
                        <small class="text-muted">Nomor ini akan digunakan untuk konfirmasi penerimaan.</small>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0 mb-4 bg-light" id="section_rqdf" style="display:none;">
                <div class="card-header bg-success text-white py-3">
                    <h5 class="m-0 fw-bold"><i class="fas fa-quran me-2"></i>Detail Kelas Reguler (Sore)</h5>
                </div>
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Pilihan Jadwal</label>
                            {{ form.tahfidz_schedule(class="form-select") }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Ukuran Seragam (2 Stel)</label>
                            {{ form.uniform_size(class="form-select", id="uniformSelector") }}
                            <small class="text-muted">Harga seragam berbeda tergantung ukuran.</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Rencana Infaq Pembangunan</label>
                        {{ form.initial_pledge_amount(class="form-select", id="infaqSelector") }}
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0 mb-4" id="section_biaya_sekolah">
                <div class="card-header bg-warning text-dark py-3">
                    <h5 class="m-0 fw-bold"><i class="fas fa-file-invoice-dollar me-2"></i>4. Rincian Pembiayaan</h5>
                </div>
                <div class="card-body p-4">
                    <div class="alert alert-warning small">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Mohon perhatikan rincian biaya di bawah ini sesuai jalur yang Anda pilih.
                    </div>

                    <h5 class="fw-bold mb-3" id="judul_biaya">Estimasi Biaya Awal Masuk</h5>

                    <div class="table-responsive">
                        <table class="table table-bordered table-striped table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Komponen Biaya</th>
                                    <th class="text-end">Nominal (Estimasi)</th>
                                </tr>
                            </thead>
                            <tbody id="tabel_biaya_body">
                                </tbody>
                            <tfoot class="table-dark">
                                <tr>
                                    <th>Total Estimasi</th>
                                    <th class="text-end" id="total_biaya">Rp 0</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="form-check mt-3">
                        {{ form.finance_agreement(class="form-check-input") }}
                        <label class="form-check-label fw-bold" for="finance_agreement">
                            Saya orang tua/wali menyatakan MENYETUJUI rincian pembiayaan di atas.
                        </label>
                        {% for error in form.finance_agreement.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="d-grid mb-5">
                {{ form.submit(class="btn btn-primary btn-lg fw-bold py-3 shadow") }}
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const programSelect = document.getElementById("programSelector");
        const scholarshipSelect = document.getElementById("scholarshipSelector");

        // Input khusus RQDF Sore
        const uniformSelect = document.getElementById("uniformSelector");
        const infaqSelect = document.getElementById("infaqSelector");

        const sectionRqdf = document.getElementById("section_rqdf");
        const sectionBiaya = document.getElementById("section_biaya_sekolah");
        const groupSekolah = document.getElementById("group_sekolah_formal");

        const tabelBody = document.getElementById("tabel_biaya_body");
        const totalBiayaEl = document.getElementById("total_biaya");
        const judulBiaya = document.getElementById("judul_biaya");

        function formatRupiah(angka) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
        }

        // --- DATA BIAYA SEKOLAH FORMAL ---
        const BIAYA_SEKOLAH_NORMAL = [
            {item: "Pendaftaran", harga: 200000},
            {item: "Seragam Batik", harga: 100000},
            {item: "Infaq Bulanan (Juli)", harga: 650000},
            {item: "Wakaf Bangunan", harga: 1000000},
            {item: "Fasilitas Kasur", harga: 500000},
            {item: "Orientasi Siswa", harga: 150000},
            {item: "Wakaf Perpustakaan", harga: 100000},
            {item: "Infaq Qurban", harga: 100000},
            {item: "Raport Pesantren", harga: 65000},
            {item: "Adm Sekolah Formal", harga: 500000},
            {item: "Infaq Kegiatan", harga: 100000}
        ];

        const BIAYA_SEKOLAH_BEASISWA = [
            {item: "Pendaftaran (Diskon)", harga: 100000},
            {item: "Infaq Bulanan (Diskon)", harga: 325000},
            {item: "Wakaf Bangunan (Diskon)", harga: 500000},
            {item: "Fasilitas Lemari", harga: 250000},
            {item: "Fasilitas Kasur", harga: 250000},
            {item: "Orientasi Siswa", harga: 75000},
            {item: "Raport", harga: 65000},
            {item: "Wakaf Perpustakaan", harga: 50000},
            {item: "Infaq Kegiatan", harga: 50000},
            {item: "Infaq Qurban", harga: 50000},
            {item: "Seragam Batik", harga: 100000},
            {item: "Adm Sekolah Formal", harga: 500000}
        ];

        // --- LOGIKA HITUNG BIAYA RQDF SORE ---
        function hitungBiayaRQDF() {
            let biayaList = [
                {item: "Infaq Pendaftaran", harga: 300000},
                {item: "Uang Dana Semesteran", harga: 50000},
                {item: "Infaq Bulanan", harga: 150000},
                {item: "Atribut (Syal) & Buku", harga: 100000},
                {item: "Raport", harga: 50000}
            ];

            // 1. Tambah Infaq Pembangunan (Dari Dropdown)
            let infaqVal = parseInt(infaqSelect.value) || 0;
            if(infaqVal > 0) {
                biayaList.push({item: "Infaq Pembangunan Pesantren", harga: infaqVal});
            } else {
                biayaList.push({item: "Infaq Pembangunan (Belum Dipilih)", harga: 0});
            }

            // 2. Tambah Seragam (Tergantung Ukuran)
            let size = uniformSelect.value;
            let hargaSeragam = 0;
            if (size === 'S' || size === 'M') hargaSeragam = 345000;
            else if (size === 'L' || size === 'XL') hargaSeragam = 355000;
            else if (size === 'XXL') hargaSeragam = 380000;

            if(hargaSeragam > 0) {
                biayaList.push({item: `Seragam RQDF (Ukuran ${size})`, harga: hargaSeragam});
            } else {
                 biayaList.push({item: "Seragam (Belum Dipilih)", harga: 0});
            }

            return biayaList;
        }

        function renderTabel(dataBiaya) {
            let html = "";
            let total = 0;
            dataBiaya.forEach(d => {
                let classText = d.harga === 0 ? "text-danger" : "text-dark";
                html += `<tr><td>${d.item}</td><td class="text-end ${classText}">${formatRupiah(d.harga)}</td></tr>`;
                total += d.harga;
            });
            tabelBody.innerHTML = html;
            totalBiayaEl.innerHTML = formatRupiah(total);
        }

        function updateForm() {
            // A. LOGIKA TAMPILAN
            if (programSelect.value === 'RQDF_SORE') {
                // Tampilan RQDF
                sectionRqdf.style.display = "block";
                groupSekolah.style.display = "none";
                judulBiaya.innerText = "Rincian Biaya Kelas Reguler (Sore)";

                // Hitung Dinamis
                let dataRQDF = hitungBiayaRQDF();
                renderTabel(dataRQDF);

            } else {
                // Tampilan Sekolah Formal
                sectionRqdf.style.display = "none";
                groupSekolah.style.display = "block";

                const jalur = scholarshipSelect.value;
                if (jalur === 'NON_BEASISWA') {
                    judulBiaya.innerText = "Rincian Biaya Jalur REGULER (Non Beasiswa)";
                    renderTabel(BIAYA_SEKOLAH_NORMAL);
                } else {
                    judulBiaya.innerText = "Rincian Biaya Jalur BEASISWA (Yatim/Tahfidz)";
                    renderTabel(BIAYA_SEKOLAH_BEASISWA);
                }
            }
        }

        // Listener
        programSelect.addEventListener("change", updateForm);
        scholarshipSelect.addEventListener("change", updateForm);

        // Listener Khusus RQDF: Update tabel realtime saat ganti ukuran/infaq
        uniformSelect.addEventListener("change", updateForm);
        infaqSelect.addEventListener("change", updateForm);

        // Init pertama kali
        updateForm();
    });
</script>
{% endblock %}