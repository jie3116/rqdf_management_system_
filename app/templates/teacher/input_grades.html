{% extends "base.html" %}

{% block content %}
<div class="container-fluid">

    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">Input Nilai Akademik</h1>
            <p class="mb-0 text-muted">
                Kelas: <strong class="text-primary">{{ target_class.name if target_class else '-' }}</strong> &bull;
                Mapel: <strong class="text-primary">{{ subject.name if subject else (majlis_subject.name if majlis_subject else '-') }}</strong>
            </p>
        </div>
        <a href="{{ url_for('teacher.dashboard') }}" class="btn btn-sm btn-secondary shadow-sm">
            <i class="fas fa-arrow-left me-1"></i> Kembali ke Dashboard
        </a>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3 bg-white">
            <ul class="nav nav-pills card-header-pills" id="gradeTabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active fw-bold" id="tab-tugas" data-bs-toggle="tab" data-bs-target="#content-tugas" type="button">
                        <i class="fas fa-tasks me-1"></i> TUGAS
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link fw-bold" id="tab-uh" data-bs-toggle="tab" data-bs-target="#content-uh" type="button">
                        <i class="fas fa-file-alt me-1"></i> ULANGAN HARIAN
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link fw-bold" id="tab-uts" data-bs-toggle="tab" data-bs-target="#content-uts" type="button">
                        <i class="fas fa-star-half-alt me-1"></i> UTS
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link fw-bold" id="tab-uas" data-bs-toggle="tab" data-bs-target="#content-uas" type="button">
                        <i class="fas fa-star me-1"></i> UAS
                    </button>
                </li>
            </ul>
        </div>
        
        <div class="card-body">
            
            {% macro grade_form(type_name) %}
            <form method="POST" action="">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                
                <input type="hidden" name="grade_type" value="{{ type_name }}">
                <input type="hidden" name="subject_id" value="{{ subject.id if subject else "" }}">
                <input type="hidden" name="majlis_subject_id" value="{{ majlis_subject.id if majlis_subject else "" }}">

                <div class="alert alert-info border-left-info py-2 small">
                    <i class="fas fa-info-circle me-1"></i> 
                    Anda sedang menginput nilai <strong>{{ type_name }}</strong>. Isi angka (0-100). Kosongkan jika siswa belum dinilai.
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle">
                        <thead class="table-light text-center">
                            <tr>
                                <th style="width: 5%">No</th>
                                <th style="width: 15%">Identitas</th>
                                <th style="width: 35%" class="text-start">Nama Peserta</th>
                                <th style="width: 25%">Nilai (Angka)</th>
                                <th style="width: 20%">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for participant in participants %}
                                {% set current_val = existing_grades.get(participant.key, {}).get(type_name, '') %}
                            <tr>
                                <td class="text-center">{{ loop.index }}</td>
                                <td class="text-center">{{ participant.identifier_label }}: {{ participant.identifier }}</td>
                                <td class="fw-bold">{{ participant.display_name }}</td>
                                <td>
                                    <input type="number" step="0.01" min="0" max="100" 
                                           name="score_{{ participant.key }}" 
                                           class="form-control text-center fw-bold text-primary"
                                           value="{{ current_val }}"
                                           placeholder="-">
                                </td>
                                <td class="text-center">
                                    {% if current_val != '' %}
                                        <span class="badge bg-success"><i class="fas fa-check me-1"></i> Tersimpan</span>
                                    {% else %}
                                        <span class="badge bg-light text-secondary border">Kosong</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                    <button type="submit" class="btn btn-primary btn-lg px-5 shadow">
                        <i class="fas fa-save me-2"></i> Simpan Nilai {{ type_name }}
                    </button>
                </div>
            </form>
            {% endmacro %}

            <div class="tab-content">
                
                <div class="tab-pane fade show active" id="content-tugas" role="tabpanel">
                    {{ grade_form('TUGAS') }}
                </div>

                <div class="tab-pane fade" id="content-uh" role="tabpanel">
                    {{ grade_form('UH') }}
                </div>

                <div class="tab-pane fade" id="content-uts" role="tabpanel">
                    {{ grade_form('UTS') }}
                </div>

                <div class="tab-pane fade" id="content-uas" role="tabpanel">
                    {{ grade_form('UAS') }}
                </div>

            </div>
        </div>
    </div>

</div>
{% endblock %}
