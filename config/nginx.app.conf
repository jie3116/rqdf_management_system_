# ------------------------------------------------------------
# KONFIGURASI NGINX - app.rqdf.co.id
# Lokasi Deploy: /etc/nginx/sites-available/app.rqdf.co.id
# ------------------------------------------------------------

# BLOK 1: Redirect HTTP (Port 80) ke HTTPS (Port 443)
server {
    listen 80;
    server_name app.rqdf.co.id;

    # Memaksa semua traffic ke HTTPS agar aman
    return 301 https://$host$request_uri;
}

# BLOK 2: Konfigurasi HTTPS (Port 443) dengan Sertifikat
server {
    listen 443 ssl;
    server_name app.rqdf.co.id;

    # --- SSL Certificate Paths ---
    ssl_certificate /etc/letsencrypt/live/app.rqdf.co.id/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/app.rqdf.co.id/privkey.pem;

    # --- Protokol & Keamanan Tambahan (Optional tapi Recommended) ---
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # Konfigurasi Log
    access_log /var/log/nginx/app_rqdf_access.log;
    error_log /var/log/nginx/app_rqdf_error.log;

    location / {
        # Arahkan ke Gunicorn (pastikan docker mapping port 8000:8000)
        proxy_pass http://127.0.0.1:8000;

        # Header penting agar Flask tahu IP asli user
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeout settings (jika aplikasi butuh waktu lama untuk memproses)
        proxy_read_timeout 120s;
    }
}